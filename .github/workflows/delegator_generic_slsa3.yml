# Copyright 2022 SLSA Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: SLSA builder delegator

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  SLSA_OUTPUTS_DIR: __SLSA_OUTPUTS_DIR__
  SLSA_ARTIFACTS_FILE: artifacts-layout.json
  SLSA_PREDICATE_FILE: predicate.json

on:
  workflow_call:
    secrets:
      secrets:
        description: >
          Optional secrets.

          This argument is passed, unchanged, to the builder's Action's `build-artifacts`.
        required: false
    inputs:
      slsa-token:
        description: "The SLSA token identifying the request"
        required: true
        type: string
    outputs:
      build-artifacts-outputs:
        description: "The outputs from the build-artitacts Action, unchanged."
        value: ${{ jobs.build-artifacts-ubuntu.outputs.outputs }}
      attestations-download-name:
        description: "Name of the artifact to download all the attestations."
        value: ${{ jobs.generate-provenance.outputs.attestations-download-name }}

jobs:
  # privacy-check verifies that the user has agreed for their repository name to be made public, via the rekor log.
  privacy-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check private repos
      run: echo all good
      # uses: slsa-framework/slsa-github-generator/.github/actions/privacy-check@main
      # with:
      #   error_message: "Repository is private. The workflow has halted in order to keep the repository name from being exposed in the public transparency log. Set 'private-repository' to override."
      #   override: ${{ inputs.allow-private-repository }}

  rng:
    outputs:
      value: ${{ steps.rng.outputs.random }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate random 16-byte value (32-char hex encoded)
        id: rng
        uses: slsa-framework/slsa-github-generator/.github/actions/rng@main

  # detect-env detects the reusable workflow's repository and ref for use later
  # in the workflow.
  detect-env:
    needs: [privacy-check, rng]
    outputs:
      repository: ${{ steps.detect.outputs.repository }}
      ref: ${{ steps.detect.outputs.ref }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Needed to detect the current reusable repository and ref.
    steps:
      - name: Detect the generator ref
        id: detect
        run: |
          echo "URL: $ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "repository=laurentsimon/slsa-delegator" >> "$GITHUB_OUTPUT" 
          echo "ref=main" >> "$GITHUB_OUTPUT" 
        #uses: slsa-framework/slsa-github-generator/.github/actions/detect-workflow@main

  # verify-token verifies the slsa token.
  verify-token:
    outputs:
      slsa-verified-token: ${{ steps.verify.outputs.slsa-verified-token }}
      tool-repository: ${{ steps.verify.outputs.tool-repository }}
      tool-ref: ${{ steps.verify.outputs.tool-ref }}
      predicate-sha256: ${{ steps.upload.outputs.sha256 }}
    runs-on: ubuntu-latest
    needs: [privacy-check, rng, detect-env]
    steps:
      - name: Checkout builder
        #TODO: add to reference pre-submit.
        uses: slsa-framework/slsa-github-generator/.github/actions/secure-builder-checkout@main
        with:
          repository: "${{ needs.detect-env.outputs.repository }}"
          ref: "${{ needs.detect-env.outputs.ref }}"
          path: __BUILDER_CHECKOUT_DIR__

      - name: Verify token with test action
        id: verify
        uses: ./__BUILDER_CHECKOUT_DIR__/.github/actions/verify-token
        with:
          slsa-workflow-recipient: "delegator_generic_slsa3.yml"
          slsa-unverified-token: ${{ inputs.slsa-token }}
          output-predicate: ${{ env.SLSA_PREDICATE_FILE }}

      - name: Debug output predicate
        env: 
          PREDICATE_FILE: ${{ env.SLSA_PREDICATE_FILE }}
        run: |
          cat "$PREDICATE_FILE" |  jq -r

      - name: Upload predicate
        id: upload
        uses: ./__BUILDER_CHECKOUT_DIR__/.github/actions/secure-upload-artifact
        with:
          name: "${{ env.SLSA_PREDICATE_FILE }}-${{ needs.rng.outputs.value }}"
          path: ${{ env.SLSA_PREDICATE_FILE }}

  # build-artifacts-ubuntu builds the projects.
  build-artifacts-ubuntu:
    needs: [privacy-check, rng, detect-env, verify-token]
    if: fromJson(needs.verify-token.outputs.slsa-verified-token).builder.runner-label == 'ubuntu-latest'
    outputs:
      outputs: ${{ toJson(steps.build-artifacts-action.outputs) }}
      artifacts-layout-sha256: ${{ steps.upload.outputs.sha256 }}
    runs-on: ubuntu-latest
    permissions:
      # TODO: we should avoid these permissions for build systems that 'run' dependency code
      # during 'compilation': e.g., npm's install scripts.
      contents: write # For release assets.
      packages: write # For publishing to GitHub packages.
    steps:
      - name: debug
        env:
          TOKEN: ${{ toJson(needs.verify-token.outputs.slsa-verified-token) }}
          RUNNER: ${{ fromJson(needs.verify-token.outputs.slsa-verified-token).builder.runner-label }}
        run: |
          echo "$TOKEN: $TOKEN"
          echo "$RUNNER: $RUNNER"

      # Checkout the builder and move it outside the workspace.
      - name: Checkout builder repository
        #TODO: add to reference pre-submit.
        uses: slsa-framework/slsa-github-generator/.github/actions/secure-builder-checkout@main
        with:
          repository: "${{ needs.detect-env.outputs.repository }}"
          ref: "${{ needs.detect-env.outputs.ref }}"
          path: __BUILDER_CHECKOUT_DIR__

      # Checkout the tool and move it outside the workspace.
      - name: Checkout the tool
        #TODO: add to reference pre-submit.
        uses: ./__BUILDER_CHECKOUT_DIR__/.github/actions/secure-builder-checkout
        with:
          repository: ${{ needs.verify-token.outputs.tool-repository }}
          ref: ${{ needs.verify-token.outputs.tool-ref }}
          path: __TOOL_CHECKOUT_DIR__

      - name: Checkout the project repository
        #TODO: add to reference pre-submit.
        #TODO: try nested checkouts.
        uses: ./__BUILDER_CHECKOUT_DIR__/.github/actions/secure-project-checkout
        with:
          repository: ${{ needs.verify-token.outputs.tool-repository }}
          ref: ${{ needs.verify-token.outputs.tool-ref }}

      - name: Move project locations
        env:
          ACTION_PATH: ${{ fromJson(needs.verify-token.outputs.slsa-verified-token).tool.actions.build-artifacts.path }}
        run: |
          set -euo pipefail

          # The builder repository (SRW).
          mv __BUILDER_CHECKOUT_DIR__ ../__BUILDER_CHECKOUT_DIR__

          # The tool repository (TRW).
          mv __TOOL_CHECKOUT_DIR__ ../__TOOL_CHECKOUT_DIR__

          # The action path to call (TRW).
          echo "ACTION_PATH=$ACTION_PATH"
          mkdir -p ../__TOOL_ACTION_DIR__
          echo ../__TOOL_CHECKOUT_DIR__/"$ACTION_PATH"/
          tree ../__TOOL_CHECKOUT_DIR__
          mv ../__TOOL_CHECKOUT_DIR__/"$ACTION_PATH"/* ../__TOOL_ACTION_DIR__/
          ls ../__TOOL_ACTION_DIR__/

          # Create the output directory.
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "SLSA_OUTPUTS_DIR: ../$SLSA_OUTPUTS_DIR"
          mkdir "../$SLSA_OUTPUTS_DIR"

          ls -l ../
          ls -l

      - name: Build artifacts
        id: build-artifacts-action
        uses: ./../__TOOL_ACTION_DIR__
        with:
          slsa-workflow-inputs: ${{ toJson(fromJson(needs.verify-token.outputs.slsa-verified-token).tool.inputs) }}
          slsa-workflow-secrets: ${{ secrets.secrets }}
          slsa-layout-file: ../${{ env.SLSA_OUTPUTS_DIR }}/${{ env.SLSA_ARTIFACTS_FILE }}

      - name: Move artifact layout file to workspace
        run: |
          set -euo pipefail
          mv "../${{ env.SLSA_OUTPUTS_DIR }}/${{ env.SLSA_ARTIFACTS_FILE }}" "${{ env.SLSA_ARTIFACTS_FILE }}"

      - name: Upload artifact layout file
        id: upload
        uses: slsa-framework/slsa-github-generator/.github/actions/secure-upload-artifact@main
        with:
          name: "${{ env.SLSA_ARTIFACTS_FILE }}-${{ needs.rng.outputs.value }}"
          path: "${{ env.SLSA_ARTIFACTS_FILE }}"

  # generate-provenance generates and signs the provenance.
  generate-provenance:
    needs: [privacy-check, rng, verify-token, build-artifacts-ubuntu]
    outputs:
      attestations-download-name: "slsa-attestations-${{ needs.rng.outputs.value }}"
    permissions:
      id-token: write # Needed to sign
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact layout file
        uses: slsa-framework/slsa-github-generator/.github/actions/secure-download-artifact@main
        with:
          name: "${{ env.SLSA_ARTIFACTS_FILE }}-${{ needs.rng.outputs.value }}"
          path: "${{ env.SLSA_ARTIFACTS_FILE }}"
          sha256: ${{ needs.build-artifacts-ubuntu.outputs.artifacts-layout-sha256 }}

      - name: Download the predicate file
        uses: slsa-framework/slsa-github-generator/.github/actions/secure-download-artifact@main
        with:
          name: "${{ env.SLSA_PREDICATE_FILE }}-${{ needs.rng.outputs.value }}"
          path: ${{ env.SLSA_PREDICATE_FILE }}
          sha256: ${{ needs.verify-token.outputs.predicate-sha256 }}

      - name: Generate attestations
        id: attestations
        uses: slsa-framework/slsa-github-generator/.github/actions/generate-attestations@main
        with:
          slsa-outputs-file: ${{ env.SLSA_ARTIFACTS_FILE }}
          predicate-type: "https://slsa.dev/provenance/v1.0?draft"
          predicate-file: ${{ env.SLSA_PREDICATE_FILE }}
          output-folder: attestations

      - name: Sign attestations
        id: sign
        uses: slsa-framework/slsa-github-generator/.github/actions/sign-attestations@main
        with:
          attestations: attestations
          output-folder: outputs

      # NOTE: we don't need to perform a secure upload, since the attestations are signed.
      - name: Upload attestations
        id: upload
        uses: actions/upload-artifact@83fd05a356d7e2593de66fc9913b3002723633cb # tag=v3.1.1
        with:
          name: outputs
          path: outputs



  